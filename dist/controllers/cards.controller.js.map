{"version":3,"sources":["../../src/controllers/cards.controller.ts"],"sourcesContent":["import { NextFunction, Request, Response } from 'express';\nimport { Container } from 'typedi';\nimport { CardsService } from '@services/cards.service';\nimport { DataStoredInToken } from '@interfaces/auth.interface';\nimport { verify } from 'jsonwebtoken';\nimport { CreateCardDto, CardUpdateDto } from '@dtos/card.dto';\nimport { Customer } from '@interfaces/customers.interface';\nimport { SECRET_KEY } from '@config';\nimport { Card } from '@interfaces/cards.interface';\n\nexport class CardsController {\n  public card = Container.get(CardsService);\n  public createCard = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n    try {\n      const customerId = this.getCustomerId(req);\n      const cardDto: CreateCardDto = req.body;\n      const lang = req.acceptsLanguages('en', 'ru', 'uz') || 'en';\n      const message = await this.card.createCard(cardDto, customerId, lang);\n      res.status(201).json({\n        success: true,\n        message,\n      });\n    } catch (error) {\n      next(error);\n    }\n  };\n  public getCustomerCards = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n    try {\n      const customer_id = this.getCustomerId(req);\n      const cards: Card[] = await this.card.getCustomerCards(String(customer_id));\n      res.status(201).json({ cards, count: cards.length });\n    } catch (error) {\n      next(error);\n    }\n  };\n  public updateCard = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n    try {\n      const customerId = this.getCustomerId(req);\n      const cardUpdateDto: CardUpdateDto = req.body;\n      const lang = req.acceptsLanguages('en', 'ru', 'uz') || 'en';\n      const message = await this.card.updateCard(String(customerId), cardUpdateDto, lang);\n      res.status(201).json({ success: true, message });\n    } catch (error) {\n      next(error);\n    }\n  };\n  public deleteCard = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n    try {\n      const customerId = this.getCustomerId(req);\n      const { id } = req.body;\n      const lang = req.acceptsLanguages('en', 'ru', 'uz') || 'en';\n      const message = await this.card.deleteCard(String(customerId), id, lang);\n      res.status(202).json({ success: true, message });\n    } catch (error) {\n      next(error);\n    }\n  };\n  public getOneById = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n    try {\n      const customerId = this.getCustomerId(req);\n      const { id } = req.params;\n      const card: Card = await this.card.getOneById(customerId, id);\n      res.status(200).json(card);\n    } catch (error) {\n      next(error);\n    }\n  };\n  public getOwnerByPan = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n    try {\n      const { pan } = req.body;\n      const owner = await this.card.getOwnerByPan(pan);\n      res.status(200).json({ owner });\n    } catch (error) {\n      next(error);\n    }\n  };\n  public addTransportCard = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\n    try {\n      const customerId = this.getCustomerId(req);\n      const card: CreateCardDto = req.body;\n      const lang = req.acceptsLanguages('en', 'ru', 'uz') || 'en';\n      const message = await this.card.addTransportCard(card, customerId, lang);\n      res.status(201).json({\n        success: true,\n        message,\n      });\n    } catch (error) {\n      next(error);\n    }\n  };\n  private getCustomerId = (req: Request): string => {\n    const cookie = req.headers.authorization;\n    const decodedToken = verify(cookie, SECRET_KEY) as DataStoredInToken;\n    return String(decodedToken.id);\n  };\n}\n"],"names":["CardsController","card","Container","get","CardsService","createCard","req","res","next","customerId","getCustomerId","cardDto","body","lang","acceptsLanguages","message","status","json","success","error","getCustomerCards","customer_id","cards","String","count","length","updateCard","cardUpdateDto","deleteCard","id","getOneById","params","getOwnerByPan","pan","owner","addTransportCard","cookie","headers","authorization","decodedToken","verify","SECRET_KEY"],"mappings":"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"}