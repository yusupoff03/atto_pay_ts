{"version":3,"sources":["../../src/middlewares/error.middleware.ts"],"sourcesContent":["import { NextFunction, Request, Response } from 'express';\nimport { logger } from '@utils/logger';\nimport pg from '@database';\nimport { CustomError } from '@exceptions/CustomError';\nimport { HttpException } from '@exceptions/httpException';\nimport { Socket } from 'socket.io';\n\nexport const ErrorMiddleware = async (error: HttpException | CustomError, req?: Request, res?: Response, next?: NextFunction) => {\n  // console.log(error);\n  try {\n    const lang = req.acceptsLanguages('en', 'ru', 'uz') || 'en';\n    const result = await defaultErrorHandler(error, lang);\n    logger.error(`[${req.method}] ${req.path} >> StatusCode:: ${result.status}, Message:: ${result.message}`);\n    res\n      .status(result.status)\n      .json({ message: result.message, status: result.status, info: result.info, type: result.type, details: result.details, stack: result.stack });\n  } catch (err) {\n    next(err);\n  }\n};\nasync function defaultErrorHandler(error, lang): Promise<{ status; type; details; stack; info; message }> {\n  const isDevenv = process.env.NODE_ENV === 'development';\n  const { rows: errorObject } = await pg.query<{ message: string; http_code: number }>(\n    `SELECT message -> $2 AS message, http_code\n       FROM message\n       WHERE name = $1`,\n    [error.name, lang],\n  );\n  const status: number = errorObject[0]?.http_code || 500;\n  let message: string = errorObject[0]?.message || 'Something went wrong';\n  let info = error.info;\n  const type = error.name;\n  const details = isDevenv ? error.message : undefined;\n  const stack = isDevenv ? error.stack : undefined;\n\n  switch (error.name) {\n    case 'USER_BLOCKED': {\n      if (errorObject) {\n        info = { ...info, message: errorObject[0].message, timeLeft: error.info };\n        message = errorObject[0].message.replace('{0}', error.info?.toString() || '60');\n      }\n      break;\n    }\n    case 'VALIDATION_ERROR': {\n      info = { ...info, message: errorObject[0].message };\n      message = errorObject[0].message.replace(`{0}`, error.info?.toString());\n      break;\n    }\n  }\n  return { status, type, details, stack, info, message };\n}\nexport const errorHandler = (socket, handler): ((args: any[]) => void) => {\n  const handleError = async err => {\n    const lang = socket.handshake.headers.lang || 'en';\n    const body = await defaultErrorHandler(err, lang);\n    if (body) {\n      socket.emit(body);\n    }\n  };\n  return (...args) => {\n    try {\n      const ret = handler.apply(this, [socket, ...args]);\n      if (ret && typeof ret.catch === 'function') {\n        ret.catch(handleError);\n      }\n    } catch (error) {\n      handleError(error);\n    }\n  };\n};\n"],"names":["ErrorMiddleware","errorHandler","error","req","res","next","lang","acceptsLanguages","result","defaultErrorHandler","logger","method","path","status","message","json","info","type","details","stack","err","errorObject","isDevenv","process","env","NODE_ENV","rows","pg","query","name","http_code","undefined","timeLeft","replace","toString","socket","handler","handleError","handshake","headers","body","emit","args","ret","apply","catch"],"mappings":"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"}