{"version":3,"sources":["../../src/services/customers.service.ts"],"sourcesContent":["import { Service } from 'typedi';\nimport pg from '@database';\nimport { HttpException } from '@exceptions/httpException';\nimport { Customer, UpdateCustomerData } from '@interfaces/customers.interface';\nimport { FileUploader } from '@utils/imageStorage';\nimport { RedisClient } from '@/database/redis';\nimport { CustomError } from '@exceptions/CustomError';\nimport moment from 'moment';\nimport { LoginQr, VerifyDto } from '@dtos/customer.dto';\nimport { createToken } from '@services/auth.service';\nimport { TokenData } from '@interfaces/auth.interface';\nimport io from '@/socket/socket';\nimport { Request } from 'express';\nimport { sendVerification } from '@services/sms.service';\n@Service()\nexport class CustomerService {\n  private redis: RedisClient;\n  constructor() {\n    this.redis = new RedisClient();\n  }\n  public async findCustomerById(customerId: string): Promise<Customer> {\n    const { rows, rowCount } = await pg.query(\n      `\n        SELECT *\n        FROM customer\n        WHERE id = $1\n      `,\n      [customerId],\n    );\n    if (!rowCount) throw new CustomError('USER_NOT_FOUND');\n    const { rows: cards } = await pg.query(`Select sum(balance) from customer_card where customer_id =$1`, [customerId]);\n    const customer: Customer = rows[0];\n    customer.balance = cards[0].sum;\n    return customer;\n  }\n  public async updateCustomer(customerId: string, customerData: UpdateCustomerData, image: any): Promise<Customer> {\n    const { rows: findCustomer } = await pg.query(\n      `\n                 SELECT *\n                 FROM customer\n                 WHERE \"id\" = $1`,\n      [customerId],\n    );\n    if (!findCustomer[0]) throw new CustomError('USER_NOT_FOUND');\n    const name = customerData.name;\n    const deleteImage = customerData.deleteImage;\n    const newName = name || findCustomer[0].name;\n    const gender = customerData.gender || findCustomer[0].gender;\n    const newBirthDate = customerData.birthDate\n      ? moment(customerData.birthDate, 'DD/MM/YYYY').format('YYYY-MM-DDTHH:mm:ss.SSS[Z]').toString()\n      : customerData.birthDate;\n    const { rows: updateCustomerData } = await pg.query(\n      `\n        UPDATE\n          customer\n        SET \"name\" = $2,\n            \"gender\"= $3,\n            \"birth_date\"=$4\n        WHERE \"id\" = $1 RETURNING *\n      `,\n      [customerId, newName, gender, newBirthDate],\n    );\n    const fileUploader = new FileUploader('eu-north-1', 'image-24');\n    if (deleteImage) {\n      await pg.query(`Update customer set image_url = $1 where id = $2`, [null, customerId]);\n      await fileUploader.deleteFile(findCustomer[0].image_url);\n    }\n    if (image) {\n      await fileUploader.deleteFile(findCustomer[0].image_url);\n      const objectKey = `${customerId}.${image.name.split('.').pop()}`;\n      const uploadPath = await fileUploader.uploadFile(image, objectKey);\n      const { rows: updateCustomer } = await pg.query(`Update customer set image_url = $1 where id= $2 returning *`, [uploadPath, customerId]);\n      if (updateCustomer[0]) {\n        updateCustomer[0].image_url = uploadPath;\n        return updateCustomer[0];\n      }\n    }\n  }\n  public async deleteCustomer(customerId: string): Promise<boolean> {\n    try {\n      const { rows: findCustomer } = await pg.query(\n        `\n          SELECT EXISTS(\n                   SELECT \"id\"\n                   FROM customer\n                   WHERE \"id\" = $1 ::uuid\n                   )`,\n        [customerId],\n      );\n\n      if (!findCustomer[0].exists) {\n        throw new HttpException(409, \"Customer doesn't exist\");\n      }\n      await pg.query(`delete from customer_device where customer_id=$1`, [customerId]);\n      await pg.query(\n        `\n          DELETE\n          FROM customer\n          WHERE id = $1\n        `,\n        [customerId],\n      );\n      return true;\n    } catch (error) {\n      console.error(`Error deleting customer:`, error);\n      throw error;\n    }\n  }\n  public static async getDeviceInfo(req: any): Promise<string> {\n    let { os, platform } = req.useragent;\n    const { browser, version } = req.useragent;\n    platform = platform === 'unknown' ? '' : platform;\n    os = os === 'unknown' ? '' : os;\n    return `${platform} ${os} ${browser} ${version}`.trim();\n  }\n  public async getOtp(phone: string): Promise<string> {\n    await this.redis.hGet('otp', phone, (err, otp) => {\n      if (err) throw new HttpException(403, err.message);\n\n      return JSON.parse(otp).code.toString();\n    });\n    throw new HttpException(404, 'Not found');\n  }\n  public async addToSaved(customerId: string, serviceId: string): Promise<void> {\n    await pg.query(\n      `\ninsert into customer_saved_service(customer_id, service_id)\nvalues($1, $2)\non conflict do nothing`,\n      [customerId, serviceId],\n    );\n  }\n  public async deleteFromSaved(customerId: string, serviceId: any): Promise<void> {\n    const { rows } = await pg.query(`Select * from customer_saved_service where service_id =$1 and customer_id = $2`, [serviceId, customerId]);\n    if (!rows[0]) {\n      throw new CustomError('SERVICE_NOT_FOUND');\n    }\n    await pg.query(`delete from customer_saved_service where customer_id  =$1 and service_id =$2`, [customerId, serviceId]);\n  }\n  public async updateCustomerLang(customerId: string, lang: string): Promise<boolean> {\n    const { rows } = await pg.query(`Select * from customer where id = $1`, [customerId]);\n    if (!rows[0]) throw new CustomError('USER_NOT_FOUND');\n\n    await pg.query(`Update customer set lang = $1 where id = $2`, [lang, customerId]);\n    return true;\n  }\n  public async loginWithQr(qrLogin: LoginQr, customerId: string): Promise<void> {\n    const redisQr = await this.redis.hGet('qr_login', customerId);\n    if (!redisQr) throw new CustomError('INVALID_REQUEST');\n    const qrObject = JSON.parse(redisQr);\n    if (qrObject.key !== qrLogin.key) throw new CustomError('INVALID_REQUEST');\n    const { rows } = await pg.query(`Select * from customer where id=$1`, [customerId]);\n    if (!rows[0]) throw new CustomError('USER_NOT_FOUND');\n    const customer: Customer = rows[0];\n    const tokenData: TokenData = createToken(customer);\n    io.to(qrObject.socketId).emit(tokenData.token);\n    return;\n  }\n  public async getDevices(customerId: string): Promise<any> {\n    const { rows } = await pg.query(`Select * from customer_device where customer_id =$1`, [customerId]);\n    return rows;\n  }\n  public async deleteCustomerDevice(deviceId, customerId: string, lang: string): Promise<string> {\n    const { rows } = await pg.query(`Select * from customer_device where device_id = $1 and customer_id = $2`, [deviceId, customerId]);\n    if (!rows[0]) {\n      throw new CustomError('ALLOWED_FOR_TRUSTED');\n    }\n    const { rows: message } = await pg.query(\n      `delete from customer_device\n    where id = $1 and customer_id = $2\n    returning (select message from message where name = 'UNTRUST_SUCCESS') as message`,\n      [rows[0].id, customerId],\n    );\n    if (!message[0]) throw new CustomError('DATABASE_ERROR');\n    return message[0].message[lang];\n  }\n  public async sendCodeToPhone(verify: VerifyDto, deviceId, resend): Promise<any> {\n    const redisCode = await this.redis.hGet('customer_otp', JSON.stringify({ phone: verify.phone, deviceId }));\n    const codeObject = JSON.parse(redisCode);\n    const codeObject1 = {\n      code: Math.floor(100000 + Math.random() * 900000),\n      expiresAt: moment().add(2, 'minutes').valueOf(),\n      numAttempt: 0,\n    };\n    const device_phone = {\n      phone: verify.phone,\n      deviceId: deviceId,\n    };\n    if (!redisCode || moment().isAfter(codeObject.expiresAt)) {\n      await this.redis.hSet('customer_otp', JSON.stringify(device_phone), JSON.stringify(codeObject1));\n      await sendVerification(device_phone.phone, codeObject1.code);\n      return moment(codeObject1.expiresAt).diff(moment(), 'seconds');\n    }\n    if (redisCode && resend) {\n      if (moment().isAfter(codeObject.expiresAt)) {\n        await this.redis.hSet('customer_otp', JSON.stringify(device_phone), JSON.stringify(codeObject1));\n        await sendVerification(device_phone.phone, codeObject1.code);\n        return moment(codeObject1.expiresAt).diff(moment(), 'seconds');\n      }\n      const timeLeft = moment(codeObject.expiresAt).diff(moment(), 'seconds');\n      throw new CustomError('CODE_ALREADY_SEND', null, { timeLeft });\n    }\n  }\n}\n"],"names":["CustomerService","findCustomerById","customerId","rows","rowCount","pg","query","CustomError","cards","customer","balance","sum","updateCustomer","customerData","image","findCustomer","name","deleteImage","newName","gender","newBirthDate","birthDate","moment","format","toString","updateCustomerData","fileUploader","FileUploader","deleteFile","image_url","objectKey","split","pop","uploadPath","uploadFile","deleteCustomer","exists","HttpException","error","console","getDeviceInfo","req","os","platform","useragent","browser","version","trim","getOtp","phone","redis","hGet","err","otp","message","JSON","parse","code","addToSaved","serviceId","deleteFromSaved","updateCustomerLang","lang","loginWithQr","qrLogin","redisQr","qrObject","key","tokenData","createToken","io","to","socketId","emit","token","getDevices","deleteCustomerDevice","deviceId","id","sendCodeToPhone","verify","resend","redisCode","stringify","codeObject","codeObject1","Math","floor","random","expiresAt","add","valueOf","numAttempt","device_phone","isAfter","hSet","sendVerification","diff","timeLeft","constructor","RedisClient","Service"],"mappings":"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"}